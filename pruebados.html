<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Transporte</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        body a {
            color: inherit; /* Hereda el color del texto de su contenedor */
            text-decoration: none; /* Elimina la subrayado predeterminado */
        }
        #container {
            width: 100%;
            max-width: 90%;
            text-align: center;
        }
        form, table {
            margin: 20px auto;
            width: 90%;
            font-size: 12px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <form id="transporteForm">
            <label for="proveedor">PROVEEDOR:</label>
            <input type="text" id="proveedor" name="proveedor" required><br><br>

            <label for="destino">DESTINO:</label>
            <input type="text" id="destino" name="destino" required><br><br>

            <label for="numParte">NÚM. PARTE:</label>
            <input type="text" id="numParte" name="numParte" required pattern="\d+" title="Solo se permiten números"><br><br>

            <label for="transportista">TRANSPORTISTA:</label>
            <input type="text" id="transportista" name="transportista" required><br><br>

            <label for="residuo">RESIDUO:</label>
            <input type="text" id="residuo" name="residuo" required><br><br>

            <label for="fechaTransporte">FECHA TRANSPORTE:</label>
            <input type="date" id="fechaTransporte" name="fechaTransporte" required><br><br>

            <label for="realizado">REALIZADO:</label>
            <input type="text" id="realizado" name="realizado" required><br><br>

            <label for="di">DI:</label>
            <input type="text" id="di" name="di" required><br><br>

            <label for="comentarios">COMENTARIOS:</label>
            <input type="text" id="comentarios" name="comentarios"><br><br>

            <button type="button" onclick="agregarFila()">Enviar</button>
            <button type="button" onclick="exportarExcel()">Exportar a Excel</button>
        </form>

        <input type="text" id="buscar" placeholder="Buscar..." onkeyup="filtrarTabla()"><br><br>

        <table id="tablaDatos">
            <thead>
                <tr>
                    <th>PROVEEDOR</th>
                    <th>DESTINO</th>
                    <th>NÚM. PARTE</th>
                    <th>TRANSPORTISTA</th>
                    <th>RESIDUO</th>
                    <th>FECHA TRANSPORTE</th>
                    <th>REALIZADO</th>
                    <th>DI</th>
                    <th>COMENTARIOS</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tablaCuerpo">
            </tbody>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAcPIP3HFgKn5E_bRjYacloUBtNYm-eyhk",
          authDomain: "tabladi.firebaseapp.com",
          projectId: "tabladi",
          storageBucket: "tabladi.appspot.com",
          messagingSenderId: "568544140345",
          appId: "1:568544140345:web:e2d840e0a6e2d59b9081e8",
          measurementId: "G-QHD08PVH7L"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        // Función para agregar una fila a la tabla y guardar en Firestore
        function agregarFila() {
            const proveedor = document.getElementById('proveedor').value;
            const destino = document.getElementById('destino').value;
            const numParte = document.getElementById('numParte').value;
            const transportista = document.getElementById('transportista').value;
            const residuo = document.getElementById('residuo').value;
            const fechaTransporte = document.getElementById('fechaTransporte').value;
            const realizado = document.getElementById('realizado').value;
            const di = document.getElementById('di').value;
            const comentarios = document.getElementById('comentarios').value;

            // Verificar campos obligatorios
            if (proveedor && destino && numParte && transportista && residuo && fechaTransporte && realizado && di) {
                // Crear objeto con los datos del registro
                const registro = {
                    proveedor: proveedor,
                    destino: destino,
                    numParte: numParte,
                    transportista: transportista,
                    residuo: residuo,
                    fechaTransporte: fechaTransporte,
                    realizado: realizado,
                    di: di,
                    comentarios: comentarios
                };

                // Guardar en Firestore
                db.collection("transportes").add(registro)
                .then(function(docRef) {
                    console.log("Documento agregado con ID: ", docRef.id);
                    // Limpiar el formulario
                    document.getElementById('transporteForm').reset();
                    // Actualizar la tabla después de agregar
                    cargarRegistros();
                })
                .catch(function(error) {
                    console.error("Error al agregar el documento: ", error);
                    alert("Error al guardar el registro. Consulta la consola para más detalles.");
                });

            } else {
                alert('Por favor, complete todos los campos obligatorios.');
            }
        }

        // Función para cargar los registros desde Firestore y mostrarlos en la tabla
        function cargarRegistros() {
            db.collection("transportes").get().then((querySnapshot) => {
                const tableBody = document.getElementById("tablaCuerpo");
                tableBody.innerHTML = "";

                querySnapshot.forEach((doc) => {
                    const registro = doc.data();
                    console.log("Cargando registro: ", registro);
                    const row = tableBody.insertRow();

                    row.insertCell().textContent = registro.proveedor;
                    row.insertCell().textContent = registro.destino;
                    row.insertCell().textContent = registro.numParte;
                    row.insertCell().textContent = registro.transportista;
                    row.insertCell().textContent = registro.residuo;
                    row.insertCell().textContent = registro.fechaTransporte;
                    row.insertCell().textContent = registro.realizado;
                    row.insertCell().textContent = registro.di;
                    row.insertCell().textContent = registro.comentarios;

                    // Botones de acciones (Editar y Eliminar)
                    const cellAcciones = row.insertCell();
                    const editarButton = document.createElement("button");
                    editarButton.textContent = "Editar";
                    editarButton.addEventListener("click", function() {
                        editarFila(doc.id, registro);
                    });
                    cellAcciones.appendChild(editarButton);

                    const eliminarButton = document.createElement("button");
                    eliminarButton.textContent = "Eliminar";
                    eliminarButton.addEventListener("click", function() {
                        eliminarFila(doc.id);
                    });
                    cellAcciones.appendChild(eliminarButton);
                });
            }).catch((error) => {
                console.error("Error al cargar los registros: ", error);
            });
        }

        // Función para editar una fila de la tabla
        function editarFila(docId, registro) {
            // Implementar la lógica de edición si es necesario
            console.log("Editar fila con ID: ", docId);
        }

        // Función para eliminar una fila de la tabla
        function eliminarFila(docId) {
            db.collection("transportes").doc(docId).delete()
                .then(function() {
                    console.log("Documento eliminado con ID: ", docId);
                    cargarRegistros();
                })
                .catch(function(error) {
                    console.error("Error al eliminar el documento: ", error);
                    alert("Error al eliminar el registro. Consulta la consola para más detalles.");
                });
        }

        // Función para exportar los datos de la tabla a un archivo Excel
        function exportarExcel() {
            const table = document.getElementById('tablaDatos');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transporte');
            XLSX.writeFile(wb, 'transporte.xlsx');
        }

        // Función para filtrar los datos de la tabla
        function filtrarTabla() {
            const filtro = document.getElementById('buscar').value.toLowerCase();
            const filas = document.getElementById('tablaCuerpo').getElementsByTagName('tr');

            for (let i = 0; i < filas.length; i++) {
                const celdas = filas[i].getElementsByTagName('td');
                let coincide = false;

                for (let j = 0; j < celdas.length; j++) {
                    if (celdas[j].innerHTML.toLowerCase().indexOf(filtro) > -1) {
                        coincide = true;
                        break;
                    }
                }

                filas[i].style.display = coincide ? '' : 'none';
            }
        }

        // Cargar los registros al cargar la página por primera vez
        document.addEventListener('DOMContentLoaded', function() {
            cargarRegistros();
        });

    </script>
</body>
</html>
